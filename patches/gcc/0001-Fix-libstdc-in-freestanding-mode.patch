From e8809fa16b83b02b314ba2f2212be97afc86af9f Mon Sep 17 00:00:00 2001
From: Dennis Bonke <admin@dennisbonke.com>
Date: Tue, 13 Apr 2021 21:07:24 +0200
Subject: [PATCH] Fix libstdc++ in freestanding mode

Signed-off-by: Dennis Bonke <admin@dennisbonke.com>
---
 libstdc++-v3/include/bits/c++config | 2 +-
 libstdc++-v3/libsupc++/new_opa.cc   | 6 ++++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/libstdc++-v3/include/bits/c++config b/libstdc++-v3/include/bits/c++config
index aa94a681fff..fbcda465d5c 100644
--- a/libstdc++-v3/include/bits/c++config
+++ b/libstdc++-v3/include/bits/c++config
@@ -669,7 +669,7 @@ namespace std
 
 // PSTL configuration
 
-#if __cplusplus >= 201703L
+#if __cplusplus >= 201703L && __has_include(<pstl/pstl_config.h>)
 // This header is not installed for freestanding:
 #if __has_include(<pstl/pstl_config.h>)
 // Preserved here so we have some idea which version of upstream we've pulled in
diff --git a/libstdc++-v3/libsupc++/new_opa.cc b/libstdc++-v3/libsupc++/new_opa.cc
index b935936e19a..5caf3ea5f9a 100644
--- a/libstdc++-v3/libsupc++/new_opa.cc
+++ b/libstdc++-v3/libsupc++/new_opa.cc
@@ -40,6 +40,12 @@ extern "C" void *memalign(std::size_t boundary, std::size_t size);
 # endif
 #endif
 
+#if !_GLIBCXX_HAVE_ALIGNED_ALLOC && !_GLIBCXX_HAVE__ALIGNED_MALLOC \
+  && !_GLIBCXX_HAVE_POSIX_MEMALIGN && !_GLIBCXX_HAVE_MEMALIGN \
+  && !_GLIBCXX_HOSTED
+extern "C" void *malloc(std::size_t size);
+#endif
+
 using std::new_handler;
 using std::bad_alloc;
 
-- 
2.31.0

