From 1f053ad7e7d8357bc20e2a655dec20fda66ab488 Mon Sep 17 00:00:00 2001
From: Dennisbonke <admin@dennisbonke.com>
Date: Sun, 3 May 2020 14:40:11 +0200
Subject: [PATCH] Various fixes for managarm support

---
 gio/gnetworking.h.in       | 2 ++
 gio/gsocket.c              | 6 ++++++
 gio/gthreadedresolver.c    | 7 +++++--
 gio/meson.build            | 4 ++--
 gio/xdgmime/xdgmimecache.c | 2 +-
 glib/glib-init.c           | 1 +
 glib/gstrfuncs.c           | 1 +
 meson.build                | 1 -
 8 files changed, 18 insertions(+), 6 deletions(-)

diff --git a/gio/gnetworking.h.in b/gio/gnetworking.h.in
index f9582b9..643820b 100644
--- a/gio/gnetworking.h.in
+++ b/gio/gnetworking.h.in
@@ -47,7 +47,9 @@
 #include <net/if.h>
 
 #include <arpa/inet.h>
+#if __has_include(<arpa/nameser.h>)
 #include <arpa/nameser.h>
+#endif
 @NAMESER_COMPAT_INCLUDE@
 
 #ifndef T_SRV
diff --git a/gio/gsocket.c b/gio/gsocket.c
index b1db8e6..aa4ba56 100644
--- a/gio/gsocket.c
+++ b/gio/gsocket.c
@@ -80,6 +80,12 @@
 #include "gwin32networking.h"
 #endif
 
+#if defined(__managarm__)
+#ifndef SO_NREAD
+#define SO_NREAD 0
+#endif
+#endif
+
 /**
  * SECTION:gsocket
  * @short_description: Low-level socket object
diff --git a/gio/gthreadedresolver.c b/gio/gthreadedresolver.c
index a6dd35c..c490777 100644
--- a/gio/gthreadedresolver.c
+++ b/gio/gthreadedresolver.c
@@ -371,7 +371,7 @@ lookup_by_address_finish (GResolver     *resolver,
 
 #if defined(G_OS_UNIX)
 
-#if defined __BIONIC__ && !defined BIND_4_COMPAT
+#if (defined(__BIONIC__) || defined(__managarm__)) && !defined BIND_4_COMPAT
 /* Copy from bionic/libc/private/arpa_nameser_compat.h
  * and bionic/libc/private/arpa_nameser.h */
 typedef struct {
@@ -906,7 +906,10 @@ free_records (GList *records)
 }
 
 #if defined(G_OS_UNIX)
-#ifdef __BIONIC__
+#if defined(__BIONIC__) || defined(__managarm__)
+#if defined(__managarm__)
+static int h_errno;
+#endif
 #ifndef C_IN
 #define C_IN 1
 #endif
diff --git a/gio/meson.build b/gio/meson.build
index d7f4f3f..118a386 100644
--- a/gio/meson.build
+++ b/gio/meson.build
@@ -32,7 +32,7 @@ elif not host_system.contains('android')
                    name : 'arpa/nameser_compat.h needed for C_IN')
       gnetworking_h_nameser_compat_include = '#include <arpa/nameser_compat.h>'
     else
-      error('Could not find required includes for ARPA C_IN')
+      warning('Could not find required includes for ARPA C_IN')
     endif
   endif
 endif
@@ -57,7 +57,7 @@ if host_system != 'windows'
       network_libs += [ cc.find_library('bind') ]
       network_args += [ '-lbind' ]
     else
-      error('Could not find res_query()')
+      warning('Could not find res_query()')
     endif
   endif
 
diff --git a/gio/xdgmime/xdgmimecache.c b/gio/xdgmime/xdgmimecache.c
index 8010f9e..e464bc5 100644
--- a/gio/xdgmime/xdgmimecache.c
+++ b/gio/xdgmime/xdgmimecache.c
@@ -34,7 +34,7 @@
 #include <fnmatch.h>
 #include <assert.h>
 
-#include <netinet/in.h> /* for ntohl/ntohs */
+#include <arpa/inet.h> /* for ntohl/ntohs */
 
 #ifdef HAVE_MMAP
 #include <sys/mman.h>
diff --git a/glib/glib-init.c b/glib/glib-init.c
index 6ffe793..5b3a290 100644
--- a/glib/glib-init.c
+++ b/glib/glib-init.c
@@ -27,6 +27,7 @@
 #include "gmem.h"       /* for g_mem_gc_friendly */
 
 #include <string.h>
+#include <strings.h>
 #include <stdlib.h>
 #include <stdio.h>
 #include <ctype.h>
diff --git a/glib/gstrfuncs.c b/glib/gstrfuncs.c
index 756dbc5..9ec36e6 100644
--- a/glib/gstrfuncs.c
+++ b/glib/gstrfuncs.c
@@ -33,6 +33,7 @@
 #include <stdlib.h>
 #include <locale.h>
 #include <string.h>
+#include <strings.h>
 #include <locale.h>
 #include <errno.h>
 #include <ctype.h>              /* For tolower() */
diff --git a/meson.build b/meson.build
index 98907ca..e0983a3 100644
--- a/meson.build
+++ b/meson.build
@@ -360,7 +360,6 @@ if cc.get_id() == 'gcc' or cc.get_id() == 'clang'
     # https://wiki.gnome.org/Projects/GLib/CompilerRequirements#Function_pointer_conversions.
     '-Wno-pedantic',
     '-Werror=declaration-after-statement',
-    '-Werror=format=2',
     '-Werror=implicit-function-declaration',
     '-Werror=init-self',
     '-Werror=missing-include-dirs',
-- 
2.26.2

