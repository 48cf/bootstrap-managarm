From 0d4316091d39436e2aa0c5929348f97d27204270 Mon Sep 17 00:00:00 2001
From: Dennis Bonke <admin@dennisbonke.com>
Date: Sun, 16 Apr 2023 20:33:01 +0200
Subject: [PATCH 1/3] Add Managarm support

Signed-off-by: Dennis Bonke <admin@dennisbonke.com>
---
 include/drm-uapi/drm.h                    | 5 +++--
 meson.build                               | 2 +-
 src/compiler/spirv/spirv_to_nir.c         | 1 +
 src/egl/main/egllog.c                     | 1 +
 src/gallium/drivers/llvmpipe/lp_texture.c | 1 -
 src/util/detect_os.h                      | 8 ++++++++
 src/util/os_misc.c                        | 4 ++--
 src/util/os_time.c                        | 4 ++--
 src/util/u_debug.c                        | 1 +
 src/util/u_thread.c                       | 4 ++--
 10 files changed, 21 insertions(+), 10 deletions(-)

diff --git a/include/drm-uapi/drm.h b/include/drm-uapi/drm.h
index c76325f..c42555b 100644
--- a/include/drm-uapi/drm.h
+++ b/include/drm-uapi/drm.h
@@ -35,10 +35,11 @@
 #ifndef _DRM_H_
 #define _DRM_H_
 
-#if   defined(__linux__)
+#if   defined(__linux__) || defined(__managarm__)
 
+#include <sys/ioctl.h>
 #include <linux/types.h>
-#include <asm/ioctl.h>
+// #include <asm/ioctl.h>
 typedef unsigned int drm_handle_t;
 
 #else /* One of the BSDs */
diff --git a/meson.build b/meson.build
index 4d26af3..d9cc4f0 100644
--- a/meson.build
+++ b/meson.build
@@ -174,7 +174,7 @@ with_any_opengl = with_opengl or with_gles1 or with_gles2
 # Only build shared_glapi if at least one OpenGL API is enabled
 with_shared_glapi = with_shared_glapi and with_any_opengl
 
-system_has_kms_drm = ['openbsd', 'netbsd', 'freebsd', 'gnu/kfreebsd', 'dragonfly', 'linux', 'sunos', 'android'].contains(host_machine.system())
+system_has_kms_drm = ['openbsd', 'netbsd', 'freebsd', 'gnu/kfreebsd', 'dragonfly', 'linux', 'sunos', 'android', 'managarm'].contains(host_machine.system())
 
 with_freedreno_kgsl = get_option('freedreno-kgsl')
 if with_freedreno_kgsl
diff --git a/src/compiler/spirv/spirv_to_nir.c b/src/compiler/spirv/spirv_to_nir.c
index 5a21f4d..dbb9fd8 100644
--- a/src/compiler/spirv/spirv_to_nir.c
+++ b/src/compiler/spirv/spirv_to_nir.c
@@ -38,6 +38,7 @@
 #include "util/u_debug.h"
 
 #include <stdio.h>
+#include <strings.h>
 
 #ifndef NDEBUG
 uint32_t mesa_spirv_debug = 0;
diff --git a/src/egl/main/egllog.c b/src/egl/main/egllog.c
index 655e139..e4b88bd 100644
--- a/src/egl/main/egllog.c
+++ b/src/egl/main/egllog.c
@@ -39,6 +39,7 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#include <strings.h>
 #include "c11/threads.h"
 #include "util/macros.h"
 #include "util/simple_mtx.h"
diff --git a/src/gallium/drivers/llvmpipe/lp_texture.c b/src/gallium/drivers/llvmpipe/lp_texture.c
index c787167..37b6c95 100644
--- a/src/gallium/drivers/llvmpipe/lp_texture.c
+++ b/src/gallium/drivers/llvmpipe/lp_texture.c
@@ -1151,7 +1151,6 @@ llvmpipe_resource_get_param(struct pipe_screen *screen,
    default:
       break;
    }
-   assert(0);
    *value = 0;
    return false;
 }
diff --git a/src/util/detect_os.h b/src/util/detect_os.h
index 6506948..469b502 100644
--- a/src/util/detect_os.h
+++ b/src/util/detect_os.h
@@ -81,6 +81,11 @@
 #define DETECT_OS_UNIX 1
 #endif
 
+#if defined(__managarm__)
+#define DETECT_OS_MANAGARM 1
+#define DETECT_OS_UNIX 1
+#endif
+
 
 /*
  * Make sure DETECT_OS_* are always defined, so that they can be used with #if
@@ -127,5 +132,8 @@
 #ifndef DETECT_OS_WINDOWS
 #define DETECT_OS_WINDOWS 0
 #endif
+#ifndef DETECT_OS_MANAGARM
+#define DETECT_OS_MANAGARM 0
+#endif
 
 #endif /* DETECT_OS_H */
diff --git a/src/util/os_misc.c b/src/util/os_misc.c
index 538b3f6..b9ee3be 100644
--- a/src/util/os_misc.c
+++ b/src/util/os_misc.c
@@ -57,7 +57,7 @@
 #  include <unistd.h>
 #  include <log/log.h>
 #  include <cutils/properties.h>
-#elif DETECT_OS_LINUX || DETECT_OS_CYGWIN || DETECT_OS_SOLARIS || DETECT_OS_HURD
+#elif DETECT_OS_LINUX || DETECT_OS_CYGWIN || DETECT_OS_SOLARIS || DETECT_OS_HURD || DETECT_OS_MANAGARM
 #  include <unistd.h>
 #elif DETECT_OS_OPENBSD || DETECT_OS_FREEBSD
 #  include <sys/resource.h>
@@ -246,7 +246,7 @@ exit_mutex:
 bool
 os_get_total_physical_memory(uint64_t *size)
 {
-#if DETECT_OS_LINUX || DETECT_OS_CYGWIN || DETECT_OS_SOLARIS || DETECT_OS_HURD
+#if DETECT_OS_LINUX || DETECT_OS_CYGWIN || DETECT_OS_SOLARIS || DETECT_OS_HURD || DETECT_OS_MANAGARM
    const long phys_pages = sysconf(_SC_PHYS_PAGES);
    const long page_size = sysconf(_SC_PAGE_SIZE);
 
diff --git a/src/util/os_time.c b/src/util/os_time.c
index c207b8f..3bf567a 100644
--- a/src/util/os_time.c
+++ b/src/util/os_time.c
@@ -53,7 +53,7 @@
 int64_t
 os_time_get_nano(void)
 {
-#if DETECT_OS_LINUX || DETECT_OS_BSD
+#if DETECT_OS_LINUX || DETECT_OS_BSD || DETECT_OS_MANAGARM
 
    struct timespec tv;
    clock_gettime(CLOCK_MONOTONIC, &tv);
@@ -92,7 +92,7 @@ os_time_get_nano(void)
 void
 os_time_sleep(int64_t usecs)
 {
-#if DETECT_OS_LINUX
+#if DETECT_OS_LINUX || DETECT_OS_MANAGARM
    struct timespec time;
    time.tv_sec = usecs / 1000000;
    time.tv_nsec = (usecs % 1000000) * 1000;
diff --git a/src/util/u_debug.c b/src/util/u_debug.c
index a5f8512..d3d46d3 100644
--- a/src/util/u_debug.c
+++ b/src/util/u_debug.c
@@ -33,6 +33,7 @@
 #include <inttypes.h>
 
 #include <stdio.h>
+#include <strings.h>
 #include <limits.h> /* CHAR_BIT */
 #include <ctype.h> /* isalnum */
 
diff --git a/src/util/u_thread.c b/src/util/u_thread.c
index 55b6b68..c508733 100644
--- a/src/util/u_thread.c
+++ b/src/util/u_thread.c
@@ -75,7 +75,7 @@ int u_thread_create(thrd_t *thrd, int (*routine)(void *), void *param)
 void u_thread_setname( const char *name )
 {
 #if defined(HAVE_PTHREAD)
-#if DETECT_OS_LINUX || DETECT_OS_CYGWIN || DETECT_OS_SOLARIS || defined(__GLIBC__)
+#if DETECT_OS_LINUX || DETECT_OS_CYGWIN || DETECT_OS_SOLARIS || defined(__GLIBC__) || DETECT_OS_MANAGARM
    int ret = pthread_setname_np(pthread_self(), name);
    if (ret == ERANGE) {
       char buf[16];
@@ -154,7 +154,7 @@ util_set_thread_affinity(thrd_t thread,
 int64_t
 util_thread_get_time_nano(thrd_t thread)
 {
-#if defined(HAVE_PTHREAD) && !defined(__APPLE__) && !defined(__HAIKU__)
+#if defined(HAVE_PTHREAD) && !defined(__APPLE__) && !defined(__HAIKU__) && !defined(__managarm__)
    struct timespec ts;
    clockid_t cid;
 
-- 
2.40.0

