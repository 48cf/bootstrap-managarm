From 8c82aabf5e95a88e8c2dbcc0567e4aa7d557dec8 Mon Sep 17 00:00:00 2001
From: Matt Taylor <mstaveleytaylor@gmail.com>
Date: Sun, 13 Feb 2022 23:31:33 +0000
Subject: [PATCH 3/3] managarm: fixes for 1.57.0

---
 Cargo.lock                         | 20 +++++++++++++++-----
 library/std/Cargo.toml             |  2 +-
 library/std/src/lib.rs             |  2 +-
 library/std/src/os/managarm/fs.rs  |  2 +-
 library/std/src/os/managarm/raw.rs |  8 ++++++++
 library/std/src/os/unix/mod.rs     |  2 ++
 6 files changed, 28 insertions(+), 8 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index dce77450..f165a0be 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1880,9 +1880,7 @@ checksum = "830d08ce1d1d941e6b30645f1a0eb5643013d835ce3779a5fc208261dbe10f55"
 
 [[package]]
 name = "libc"
-version = "0.2.103"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "dd8f7255a17a627354f321ef0055d63b898c6fb27eff628af4d1b66b7331edf6"
+version = "0.2.117"
 dependencies = [
  "rustc-std-workspace-core",
 ]
@@ -2291,9 +2289,9 @@ dependencies = [
 
 [[package]]
 name = "num_cpus"
-version = "1.13.0"
+version = "1.13.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "05499f3756671c15885fee9034446956fff3f243d6077b91e5767df161f766b3"
+checksum = "19e64526ebdee182341572e50e9ad03965aa510cd94427a4549448f285e957a1"
 dependencies = [
  "hermit-abi",
  "libc",
@@ -5792,3 +5790,15 @@ checksum = "fe5c30ade05e61656247b2e334a031dfd0cc466fadef865bdcdea8d537951bf1"
 dependencies = [
  "winapi",
 ]
+
+[[patch.unused]]
+name = "backtrace"
+version = "0.3.64"
+
+[[patch.unused]]
+name = "num_cpus"
+version = "1.13.0"
+
+[[patch.unused]]
+name = "users"
+version = "0.11.0"
diff --git a/library/std/Cargo.toml b/library/std/Cargo.toml
index 6bc445c6..96f574ce 100644
--- a/library/std/Cargo.toml
+++ b/library/std/Cargo.toml
@@ -15,7 +15,7 @@ cfg-if = { version = "0.1.8", features = ['rustc-dep-of-std'] }
 panic_unwind = { path = "../panic_unwind", optional = true }
 panic_abort = { path = "../panic_abort" }
 core = { path = "../core" }
-libc = { version = "0.2.103", default-features = false, features = ['rustc-dep-of-std'] }
+libc = { path = "../../../rust-libc", default-features = false, features = ['rustc-dep-of-std'] }
 compiler_builtins = { version = "0.1.44" }
 profiler_builtins = { path = "../profiler_builtins", optional = true }
 unwind = { path = "../unwind" }
diff --git a/library/std/src/lib.rs b/library/std/src/lib.rs
index 1d2d26b8..48d385a2 100644
--- a/library/std/src/lib.rs
+++ b/library/std/src/lib.rs
@@ -545,7 +545,7 @@ pub mod task {
 // Private support modules
 mod panicking;
 
-#[path = "../../backtrace/src/lib.rs"]
+#[path = "../../../../rust-backtrace/src/lib.rs"]
 #[allow(dead_code, unused_attributes)]
 mod backtrace_rs;
 
diff --git a/library/std/src/os/managarm/fs.rs b/library/std/src/os/managarm/fs.rs
index efd774d2..dd8f2955 100644
--- a/library/std/src/os/managarm/fs.rs
+++ b/library/std/src/os/managarm/fs.rs
@@ -1,4 +1,4 @@
-#![stable(feature = "raw_ext", since = "1.1.0")]
+#![stable(feature = "metadata_ext", since = "1.1.0")]
 
 use crate::fs::Metadata;
 use crate::sys_common::AsInner;
diff --git a/library/std/src/os/managarm/raw.rs b/library/std/src/os/managarm/raw.rs
index 5124020d..0e8bdd77 100644
--- a/library/std/src/os/managarm/raw.rs
+++ b/library/std/src/os/managarm/raw.rs
@@ -1,4 +1,12 @@
 #![stable(feature = "raw_ext", since = "1.1.0")]
+#![rustc_deprecated(
+    since = "1.8.0",
+    reason = "these type aliases are no longer supported by \
+              the standard library, the `libc` crate on \
+              crates.io should be used instead for the correct \
+              definitions"
+)]
+#![allow(deprecated)]
 
 #[stable(feature = "pthread_t", since = "1.8.0")]
 pub type pthread_t = usize; // TODO: This is completely wrong tbh
diff --git a/library/std/src/os/unix/mod.rs b/library/std/src/os/unix/mod.rs
index 62f750fa..00c6e3ab 100644
--- a/library/std/src/os/unix/mod.rs
+++ b/library/std/src/os/unix/mod.rs
@@ -59,6 +59,8 @@ mod platform {
     pub use crate::os::linux::*;
     #[cfg(target_os = "macos")]
     pub use crate::os::macos::*;
+    #[cfg(target_os = "managarm")]
+    pub use crate::os::managarm::*;
     #[cfg(target_os = "netbsd")]
     pub use crate::os::netbsd::*;
     #[cfg(target_os = "openbsd")]
-- 
2.35.1

