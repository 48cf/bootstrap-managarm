From 71d14cc4f054b9f24e6b0432aaad29e6bfb16acf Mon Sep 17 00:00:00 2001
From: no92 <no92.mail@gmail.com>
Date: Fri, 14 Jan 2022 03:23:05 +0100
Subject: [PATCH] Managarm-specific changes

---
 compositor/main.c              | 10 +---------
 libweston/backend-drm/drm.c    | 12 ++++++------
 libweston/backend-drm/fb.c     |  3 ++-
 libweston/launcher-util.c      | 16 ++--------------
 tools/zunitc/src/zunitc_impl.c |  1 +
 5 files changed, 12 insertions(+), 30 deletions(-)

diff --git a/compositor/main.c b/compositor/main.c
index 322f2ff..801d5fe 100644
--- a/compositor/main.c
+++ b/compositor/main.c
@@ -44,7 +44,7 @@
 #include <libevdev/libevdev.h>
 #include <linux/input.h>
 #include <sys/time.h>
-#include <linux/limits.h>
+#include <limits.h>
 
 #include "weston.h"
 #include <libweston/libweston.h>
@@ -819,14 +819,6 @@ weston_compositor_log_capabilities(struct weston_compositor *compositor)
 	weston_log_continue(STAMP_SPACE "presentation clock: %s, id %d\n",
 			    clock_name(compositor->presentation_clock),
 			    compositor->presentation_clock);
-
-	if (clock_getres(compositor->presentation_clock, &res) == 0)
-		weston_log_continue(STAMP_SPACE
-				"presentation clock resolution: %d.%09ld s\n",
-				(int)res.tv_sec, res.tv_nsec);
-	else
-		weston_log_continue(STAMP_SPACE
-				"presentation clock resolution: N/A\n");
 }
 
 static bool
diff --git a/libweston/backend-drm/drm.c b/libweston/backend-drm/drm.c
index 4278770..5ba7adb 100644
--- a/libweston/backend-drm/drm.c
+++ b/libweston/backend-drm/drm.c
@@ -559,7 +559,7 @@ drm_output_start_repaint_loop(struct weston_output *output_base)
 
 	/* Try to get current msc and timestamp via instant query */
 	vbl.request.type |= drm_waitvblank_pipe(output->crtc);
-	ret = drmWaitVBlank(backend->drm.fd, &vbl);
+	ret = -1; //drmWaitVBlank(backend->drm.fd, &vbl);
 
 	/* Error ret or zero timestamp means failure to get valid timestamp */
 	if ((ret == 0) && (vbl.reply.tval_sec > 0 || vbl.reply.tval_usec > 0)) {
@@ -629,11 +629,11 @@ drm_repaint_begin(struct weston_compositor *compositor)
 	b->repaint_data = ret;
 
 	if (weston_log_scope_is_enabled(b->debug)) {
-		char *dbg = weston_compositor_print_scene_graph(compositor);
+		// char *dbg = weston_compositor_print_scene_graph(compositor);
 		drm_debug(b, "[repaint] Beginning repaint; pending_state %p\n",
 			  ret);
-		drm_debug(b, "%s", dbg);
-		free(dbg);
+		// drm_debug(b, "%s", dbg);
+		// free(dbg);
 	}
 
 	return ret;
@@ -3019,7 +3019,7 @@ drm_backend_create(struct weston_compositor *compositor,
 	if (parse_gbm_format(config->gbm_format, DRM_FORMAT_XRGB8888, &b->gbm_format) < 0)
 		goto err_compositor;
 
-	/* Check if we run drm-backend using weston-launch */
+	/* Check if we run drm-backend using weston-launch
 	compositor->launcher = weston_launcher_connect(compositor, config->tty,
 						       seat_id, true);
 	if (compositor->launcher == NULL) {
@@ -3027,7 +3027,7 @@ drm_backend_create(struct weston_compositor *compositor,
 			   "weston-launch binary, or your system should "
 			   "provide the logind D-Bus API.\n");
 		goto err_compositor;
-	}
+	} */
 
 	b->udev = udev_new();
 	if (b->udev == NULL) {
diff --git a/libweston/backend-drm/fb.c b/libweston/backend-drm/fb.c
index ffe2cc5..a6664a8 100644
--- a/libweston/backend-drm/fb.c
+++ b/libweston/backend-drm/fb.c
@@ -385,13 +385,14 @@ drm_fb_get_from_bo(struct gbm_bo *bo, struct drm_backend *backend,
 	if (is_opaque)
 		fb->format = pixel_format_get_opaque_substitute(fb->format);
 
+	/*
 	if (backend->min_width > fb->width ||
 	    fb->width > backend->max_width ||
 	    backend->min_height > fb->height ||
 	    fb->height > backend->max_height) {
 		weston_log("bo geometry out of bounds\n");
 		goto err_free;
-	}
+	} */
 
 	if (drm_fb_addfb(backend, fb) != 0) {
 		if (type == BUFFER_GBM_SURFACE)
diff --git a/libweston/launcher-util.c b/libweston/launcher-util.c
index b2219b6..e627e1e 100644
--- a/libweston/launcher-util.c
+++ b/libweston/launcher-util.c
@@ -76,7 +76,8 @@ WL_EXPORT int
 weston_launcher_open(struct weston_launcher *launcher,
 		     const char *path, int flags)
 {
-	return launcher->iface->open(launcher, path, flags);
+	return open(path, flags);
+	// return launcher->iface->open(launcher, path, flags);
 }
 
 WL_EXPORT void
@@ -111,17 +112,4 @@ weston_setup_vt_switch_bindings(struct weston_compositor *compositor)
 	int ret;
 	uint32_t key;
 	struct weston_launcher *launcher = compositor->launcher;
-
-	ret = launcher->iface->get_vt(launcher);
-	if (ret < 0 && ret != -ENOSYS)
-		return;
-
-	if (compositor->vt_switching == false)
-		return;
-
-	for (key = KEY_F1; key < KEY_F9; key++)
-		weston_compositor_add_key_binding(compositor, key,
-						  MODIFIER_CTRL | MODIFIER_ALT,
-						  switch_vt_binding,
-						  compositor);
 }
diff --git a/tools/zunitc/src/zunitc_impl.c b/tools/zunitc/src/zunitc_impl.c
index 395bdd7..e11a32f 100644
--- a/tools/zunitc/src/zunitc_impl.c
+++ b/tools/zunitc/src/zunitc_impl.c
@@ -27,6 +27,7 @@
 
 #include <errno.h>
 #include <fcntl.h>
+#include <signal.h>
 #include <stdarg.h>
 #include <stdbool.h>
 #include <stdio.h>
-- 
2.37.1

